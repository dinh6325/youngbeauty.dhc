{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
  <div class="card shadow-sm">
    <div class="row g-0">

      <!-- ·∫¢nh s·∫£n ph·∫©m -->
      <div class="col-md-6 text-center">
        {% if product.image %}
          <img src="{{ product.image.url }}" class="img-fluid product-img" alt="{{ product.name }}">
        {% else %}
          <img src="https://via.placeholder.com/600x600?text=No+Image" class="img-fluid product-img" alt="No image">
        {% endif %}
      </div>

      <!-- Th√¥ng tin s·∫£n ph·∫©m -->
      <div class="col-md-6">
        <div class="card-body">

          <h2 class="card-title">{{ product.name }}</h2>
          <p class="text-muted small">Danh m·ª•c: {{ product.category.name }}</p>

          <!-- GI√Å TI·ªÄN -->
          <div class="price">
            {{ product.price_vnd }}
          </div>

          <!-- Rating & t·ªìn kho -->
          <div class="mb-3">
            {% if product.stock > 0 %}
              <span class="text-warning fw-semibold">‚≠ê {{ product.rating }}</span>
              <span class="text-muted ms-2">C√≤n l·∫°i: {{ product.stock }}</span>
            {% else %}
              <span class="text-danger fw-bold">H·∫øt h√†ng</span>
            {% endif %}
          </div>

          <div class="description">
            {{ product.description|safe }}
          </div>

          {% if product.stock > 0 %}
          <form method="post" action="{% url 'shop:cart' %}">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">

            <!-- S·ªê L∆Ø·ª¢NG -->
            <div class="d-flex align-items-center mb-4">
              <label class="me-3 fw-semibold">S·ªë l∆∞·ª£ng:</label>
              <div class="input-group qty-group">
                <button type="button" class="btn btn-outline-secondary" id="decBtn">‚àí</button>
                <input type="number"
                       id="qtyInput"
                       name="quantity"
                       value="1"
                       min="1"
                       max="{{ product.stock }}"
                       class="form-control text-center">
                <button type="button" class="btn btn-outline-secondary" id="incBtn">+</button>
              </div>
            </div>

            <!-- N√öT -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success flex-fill">
                üõí Th√™m v√†o gi·ªè
              </button>
              <button type="button" id="buyNowBtn" class="btn btn-primary flex-fill">
                ‚ö° Mua ngay
              </button>
            </div>
          </form>
          {% else %}
            <div class="alert alert-danger fw-bold mt-3">
              S·∫£n ph·∫©m hi·ªán ƒë√£ h·∫øt h√†ng.
            </div>
          {% endif %}

          <!-- THANH TO√ÅN -->
          <div id="paymentForm" class="payment-box mt-4" style="display:none;">
            <h4>Thanh to√°n</h4>
            <form method="post" action="{% url 'shop:cart' %}">
              {% csrf_token %}
              <input type="hidden" name="product_id" value="{{ product.id }}">
              <div class="mb-3">
                <label class="form-label">S·ªë l∆∞·ª£ng</label>
                
              </div>
              <button type="submit" class="btn btn-success">X√°c nh·∫≠n</button>
              <button type="button" id="cancelPaymentBtn" class="btn btn-secondary ms-2">H·ªßy</button>
            </form>
          </div>

          <a href="{% url 'shop:home' %}" class="btn btn-link mt-4">
            ‚Üê Quay l·∫°i danh s√°ch
          </a>

        </div>
      </div>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="mt-4">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  </div>

  <!-- COMMENTS -->
  <div class="mt-5">
    <h3>Comment s·∫£n ph·∫©m</h3>

    {% if comments %}
      <ul class="list-group mb-4">
        {% for comment in comments %}
          <li class="list-group-item">
            <strong>{{ comment.user.username }}</strong>
            <span class="text-warning">‚≠ê {{ comment.rating }}</span>
            <p>{{ comment.comment|linebreaks }}</p>
            <small class="text-muted">{{ comment.created_at|date:"d/m/Y H:i" }}</small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>Ch∆∞a c√≥ comment n√†o.</p>
    {% endif %}

    {% if user.is_authenticated %}
      <h4>Vi·∫øt comment</h4>
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          {{ form.rating.label_tag }}
          {{ form.rating }}
        </div>
        <div class="mb-3">
          {{ form.comment.label_tag }}
          {{ form.comment }}
        </div>
        <button class="btn btn-primary">G·ª≠i</button>
      </form>
    {% else %}
      <p><a href="{% url 'login' %}?next={{ request.path }}">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ comment.</p>
    {% endif %}
  </div>
</div>

<!-- JS -->
<script>
  const decBtn = document.getElementById('decBtn');
  const incBtn = document.getElementById('incBtn');
  const qtyInput = document.getElementById('qtyInput');
  const maxStock = {{ product.stock|default:0 }};

  decBtn.onclick = () => {
    let v = parseInt(qtyInput.value) || 1;
    if (v > 1) qtyInput.value = v - 1;
  };

  incBtn.onclick = () => {
    let v = parseInt(qtyInput.value) || 1;
    if (v < maxStock) qtyInput.value = v + 1;
  };

  document.getElementById('buyNowBtn').onclick = () => {
    document.getElementById('paymentForm').style.display = 'block';
  };

  document.getElementById('cancelPaymentBtn').onclick = () => {
    document.getElementById('paymentForm').style.display = 'none';
  };
</script>

<!-- CSS -->
<style>
.card {
  border-radius: 14px;
  border: none;
}

.product-img {
  max-height: 520px;
  object-fit: contain;
  background: #fafafa;
  padding: 20px;
  border-radius: 14px;
}

.card-title {
  font-size: 1.9rem;
  font-weight: 700;
}

.price {
  font-size: 2.1rem;
  font-weight: 800;
  color: #d70018;
  margin: 10px 0 15px;
}

.description {
  line-height: 1.6;
  color: #444;
}

.qty-group {
  max-width: 160px;
}

.payment-box {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #e0e0e0;
}

.list-group-item {
  border-radius: 10px;
  margin-bottom: 10px;
}

@media (max-width: 768px) {
  .price {
    font-size: 1.7rem;
  }
}
</style>
{% endblock %}
